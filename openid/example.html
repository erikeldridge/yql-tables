<a id="openid">click</a>
<script src="http://yui.yahooapis.com/3.0.0/build/yui/yui-min.js"></script>
<script>
    YUI( {
        modules: {
            'gallery-storage-lite': {
                fullpath: 'http://yui.yahooapis.com/gallery-2010.02.22-22/build/gallery-storage-lite/gallery-storage-lite-min.js',
                requires: ['event-base','event-custom','event-custom-complex','json'],
                optional: [],
                supersedes: []
          }

        }
    } ).use('io', 'gallery-storage-lite', function (Y) {
        var handleIoComplete = function (id, o, args) {
                var json = Y.JSON.parse(o.responseText);
                Y.Node.get('#openid').set('href', json.query.results.success);
            },
            handleStorageReady = function () {
                var returnTo = 'test.erikeldridge.com';
                // var tableUri = 'http://github.com/erikeldridge/yql-tables/raw/master/openid/openid.xml';
                var tableUri = 'http://test.erikeldridge.com/yql/openid/openid.xml';
                var assocHandle = Y.StorageLite.getItem('openid-assoc', true).query.results.success.assoc_handle,
                
                    //attribute exchange (http://developer.yahoo.net/blog/archives/2009/12/yahoo_openid_now_with_attribute_exchange.html)
                    axJson = Y.JSON.stringify([{
                    	'schema':'http://axschema.org/contact/email',
                    	'alias': 'email',
                    	'required':true
                    },
                    {
                    	'schema':'http://axschema.org/namePerson',
                    	'alias':'fullname',
                    	'required':true
                    },
                    {
                    	'schema':'http://axschema.org/media/image/default',
                    	'alias':'profile_pic',
                    	'required':true
                    },
                    {
                    	'schema':'http://axschema.org/person/gender',
                    	'alias':'gender',
                    	'required':true
                    }]),
                    
                    //hybrid auth (http://developer.yahoo.net/blog/archives/2009/09/yahoo_openid_hybrid.html)
                    oauthKey = 'youroauthkeyMcnVxUVBQJmQ9WVdrOU56RmlaMGxXTjJzbWNHbzlNVEl5TWprNE16a3gmcz1jb25zdW1lcnNlY3JldCZ4PTI5',
                    
                    params = [
                        'q='+encodeURIComponent('use "'+tableUri+'" as table; '
                            + 'select * from table where '
                            + 'id="yahoo.com" and '
                            + 'return_to="http://'+returnTo+'" and '
                            + 'assoc_handle="'+assocHandle+'" and '
                            + "axJson='"+axJson+"' and "
                            + "oauthKey='"+oauthKey+"'"),
                        'callback=',
                        'diagnostics=true',
                        'format=json',
                        'debug=true'
                    ],
                    url = "http://query.yahooapis.com/v1/public/yql?"+params.join('&'),
                    ioConfig = {
                        method: 'GET',
                        on: {
                            success: handleIoComplete
                        },
                        xdr: {
                            use: 'flash'
                        }
                    },
                    xdrConfig = {
                        id:'flash',
                        yid: Y.id, 
                        src:'../../../../io.swf'
                    };

                    Y.io.transport(xdrConfig);

                    Y.on('io:xdrReady', function () {
                        Y.io(url, ioConfig);
                    });
            };
            
        //run test.assoc.html first to store assoc fields
        Y.StorageLite.on( 'storage-lite:ready', handleStorageReady );
            

    });
</script>